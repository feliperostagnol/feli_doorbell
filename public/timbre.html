<script>
const video = document.getElementById("video");
const statusEl = document.getElementById("status");
const snapBtn = document.getElementById("snap");

// Esperar a que el video realmente cargue
video.addEventListener("loadedmetadata", () => {
  console.log("ğŸ“¸ CÃ¡mara lista:", video.videoWidth, video.videoHeight);
});

async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error accediendo a la cÃ¡mara.";
  }
}
initCamera();

snapBtn.addEventListener("click", async () => {
  statusEl.textContent = "Enviandoâ€¦";

  // ğŸ’¥ Esperar SI O SI que la cÃ¡mara tenga dimensiones reales
  if (video.videoWidth === 0 || video.videoHeight === 0) {
    await new Promise(r => setTimeout(r, 200));
  }

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // ğŸ’¥ GARANTIZAR que toBlob siempre devuelva un blob vÃ¡lido
  const blob = await new Promise(resolve => {
    canvas.toBlob(b => resolve(b || new Blob()), "image/jpeg", 0.9);
  });

  const formData = new FormData();
  formData.append("photo", blob, "timbre.jpg");
  formData.append("message", "Alguien tocÃ³ el timbre ğŸšªğŸ””");

  try {
    const res = await fetch("/api/send", {
      method: "POST",
      body: formData
    });

    const json = await res.json();
    console.log(json);

    if (json.ok) {
      statusEl.textContent = "Timbre enviado âœ”ï¸";
    } else {
      statusEl.textContent = "Error enviando el timbre âŒ";
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Error de red âŒ";
  }
});
</script>
