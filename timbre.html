<button id="snap">Tocar timbre</button>
<video id="cam" autoplay></video>

<script>
const snap = document.getElementById("snap");
const cam = document.getElementById("cam");

async function validateToken() {
  const token = new URLSearchParams(window.location.search).get("token");
  const res = await fetch(`/api/check?token=${token}`);
  const data = await res.json();

  if (!data.valid) {
    document.body.innerHTML = "<h2>Token expirado. Volv√© a escanear el QR.</h2>";
    return false;
  }
  return true;
}

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });
  cam.srcObject = stream;
}

snap.onclick = async () => {
  const canvas = document.createElement("canvas");
  canvas.width = cam.videoWidth;
  canvas.height = cam.videoHeight;
  const c = canvas.getContext("2d");
  c.drawImage(cam, 0, 0, canvas.width, canvas.height);

  const base64 = canvas.toDataURL("image/jpeg");

  await fetch("/api/check", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ photo: base64 })
  });

  alert("Aviso enviado üëç");
};

validateToken();
startCamera();
</script>
