<script>
async function validateToken() {
  const token = new URLSearchParams(window.location.search).get("token");

  const res = await fetch(`/api/check?token=${token}`);
  const data = await res.json();

  if (!data.valid) {
    document.body.innerHTML = "<h2>Token expirado. Volv√© a escanear el QR.</h2>";
    return false;
  }

  return true;
}

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });
  cam.srcObject = stream;
}

snap.onclick = async () => {
  const canvas = document.createElement('canvas');
  canvas.width = cam.videoWidth;
  canvas.height = cam.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);

  const base64 = canvas.toDataURL("image/jpeg");

  // üî• CORREGIDO: ahora llama al endpoint correcto
  await fetch('/api/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ photo: base64 })
  });

  alert("Aviso enviado üëç");
};
</script>
